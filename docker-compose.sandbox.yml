version: '3.8'

# ğŸ§ª SANDBOX ENVIRONMENT FOR RAG + MEMORY TESTING
# Isolated from production - Safe to break!

services:
  # ==========================================
  # MILVUS VECTOR DATABASE
  # ==========================================
  sandbox-etcd:
    container_name: sandbox-milvus-etcd
    image: quay.io/coreos/etcd:v3.5.5
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://sandbox-etcd:2379
    volumes:
      - sandbox_etcd_data:/etcd
    networks:
      - sandbox-network

  sandbox-minio:
    container_name: sandbox-milvus-minio
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    environment:
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    command: minio server /minio_data --console-address ":9001"
    ports:
      - "9410:9000"  # Changed port to avoid conflict
      - "9411:9001"  # Console
    volumes:
      - sandbox_minio_data:/minio_data
    networks:
      - sandbox-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  sandbox-milvus:
    container_name: sandbox-milvus
    image: milvusdb/milvus:v2.3.4
    command: ["milvus", "run", "standalone"]
    environment:
      ETCD_ENDPOINTS: sandbox-etcd:2379
      MINIO_ADDRESS: sandbox-minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    ports:
      - "19540:19530"  # Changed port to avoid conflict
      - "9095:9091"    # Metrics
    depends_on:
      - sandbox-etcd
      - sandbox-minio
    volumes:
      - sandbox_milvus_data:/var/lib/milvus
    networks:
      - sandbox-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 30s
      timeout: 20s
      retries: 5

  # ==========================================
  # ATTU (Milvus Web UI)
  # ==========================================
  sandbox-attu:
    container_name: sandbox-attu
    image: zilliz/attu:latest
    environment:
      MILVUS_URL: sandbox-milvus:19530
    ports:
      - "3456:3000"  # Attu web interface
    depends_on:
      - sandbox-milvus
    networks:
      - sandbox-network

  # ==========================================
  # POSTGRES (for memory tables)
  # ==========================================
  sandbox-postgres:
    container_name: sandbox-postgres
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: sandbox_ioc
      POSTGRES_USER: sandbox_user
      POSTGRES_PASSWORD: sandbox_pass
    ports:
      - "5433:5432"  # Changed port to avoid conflict
    volumes:
      - sandbox_postgres_data:/var/lib/postgresql/data
    networks:
      - sandbox-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sandbox_user -d sandbox_ioc"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # REDIS (optional - for caching)
  # ==========================================
  sandbox-redis:
    container_name: sandbox-redis
    image: redis:7-alpine
    ports:
      - "6380:6379"  # Changed port to avoid conflict
    volumes:
      - sandbox_redis_data:/data
    networks:
      - sandbox-network
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # SANDBOX API (with RAG + Memory)
  # ==========================================
  sandbox-api:
    container_name: sandbox-api
    build:
      context: .
      dockerfile: Dockerfile.sandbox
    environment:
      # Database
      DATABASE_URL: postgresql+asyncpg://sandbox_user:sandbox_pass@sandbox-postgres:5432/sandbox_ioc
      
      # Milvus
      MILVUS_HOST: sandbox-milvus
      MILVUS_PORT: 19530
      MILVUS_COLLECTION: sandbox_function_embeddings
      
      # Redis
      REDIS_URL: redis://sandbox-redis:6379/0
      
      # Jina (use local or provide API key)
      JINA_API_KEY: ${JINA_API_KEY:-}
      
      # LLM
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      
      # RAG Config
      RAG_STAGE1_TOP_K: 50
      RAG_STAGE2_TOP_K: 5
      
      # ReAct Config
      REACT_MAX_ITERATIONS: 5
      REACT_QUALITY_THRESHOLD: 0.8
      
      # Debug
      LOG_LEVEL: DEBUG
    ports:
      - "8002:8000"  # Changed port to avoid conflict
    depends_on:
      sandbox-postgres:
        condition: service_healthy
      sandbox-milvus:
        condition: service_healthy
      sandbox-redis:
        condition: service_healthy
    volumes:
      - ./backend:/app/backend
      - ./config:/app/config
      - ./scripts:/app/scripts
    networks:
      - sandbox-network
    command: >
      sh -c "
        echo 'ğŸ§ª Starting Sandbox API...' &&
        echo 'â³ Waiting for services...' &&
        sleep 10 &&
        echo 'ğŸ“Š Running migrations...' &&
        python scripts/migrations/add_memory_tables.py &&
        echo 'ğŸš€ Starting FastAPI...' &&
        uvicorn backend.main:app --host 0.0.0.0 --port 8000 --reload
      "

networks:
  sandbox-network:
    name: sandbox-network
    driver: bridge

volumes:
  sandbox_etcd_data:
  sandbox_minio_data:
  sandbox_milvus_data:
  sandbox_postgres_data:
  sandbox_redis_data:
